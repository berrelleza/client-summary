<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Summary</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #summary {
      white-space: pre-wrap; background: #f5f5f5; padding: 10px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    #debug {
      margin-top: 12px; font-size: 12px; opacity: .8;
      background: #fafafa; border: 1px dashed #ddd; padding: 8px;
    }
  </style>
</head>
<body>
  <h2>üìù Client Summary</h2>
  <div id="summary">Cargando...</div>
  <pre id="debug"></pre>

  <script>
  // ‚ö†Ô∏è PON AQU√ç TU API KEY (de la misma subcuenta donde est√° el contacto)
  const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6IjB0N1JJYXNYZ3Vmekt3WmFSVzByIiwidmVyc2lvbiI6MSwiaWF0IjoxNzUyNjE1ODMwMjI2LCJzdWIiOiJRT05DeVdOU2d1U0U2bHVlMEhZMSJ9.Ufvz6D6JDPKOI46oUer34Kznr1V8Dh--k2arVp55Q1g";

  // Lee contactId de la URL
  const params    = new URLSearchParams(location.search);
  const contactId = params.get("contactId");

  // Clave √öNICA EXACTA de tu campo (sin llaves)
  const SUMMARY_FIELD_KEY  = "contact.client_summary";   // ‚Üê importante
  const SUMMARY_FIELD_NAME = "Client Summary";           // respaldo por nombre

  const HDRS = { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" };
  const log  = (...a)=>{ const d=document.getElementById("debug"); if(d) d.textContent+=a.join(" ")+"\n"; console.log(...a); };

  async function j(url){ const r=await fetch(url,{headers:HDRS,cache:"no-store"}); return r.json(); }

  // IDs de campos que se llaman "Client Summary" (por si hay duplicados)
  async function getFieldIdsByName() {
    const data = await j("https://rest.gohighlevel.com/v1/custom-fields");
    const list = data.customFields || [];
    const norm = s => (s||"").trim().toLowerCase();
    const ids  = list
      .filter(f => (f.model==="contact"||!f.model) && norm(f.name)===norm(SUMMARY_FIELD_NAME))
      .map(f => f.id);
    log("coincidencias por nombre:", ids.length);
    return ids;
  }

  async function load() {
    try {
      if (!contactId) throw new Error("No lleg√≥ contactId en la URL");
      log("contactId:", contactId);

      const ids = await getFieldIdsByName();

      // Trae el contacto (incluye ambas formas de custom fields)
      const c = await j(`https://rest.gohighlevel.com/v1/contacts/${contactId}?include=customFields`);

      let value = "";

      // 1) PRIMERO: por Unique Key en el objeto customField
      if (c.customField && typeof c.customField === "object") {
        if (SUMMARY_FIELD_KEY in c.customField) {
          value = c.customField[SUMMARY_FIELD_KEY] || "";
          if (value) log("match por KEY:", SUMMARY_FIELD_KEY);
        }
      }

      // 2) Si no hay valor, probar por ID (objeto)
      if (!value && c.customField && typeof c.customField === "object") {
        for (const fid of ids) {
          if (c.customField[fid]) { value = c.customField[fid]; log("match por ID en objeto:", fid); break; }
        }
      }

      // 3) Si a√∫n nada, probar por ID en el arreglo [{id,value}] / [{customFieldId,value}]
      if (!value && Array.isArray(c.customFields)) {
        for (const fid of ids) {
          const hit = c.customFields.find(cf => (cf.id===fid || cf.customFieldId===fid) && cf.value);
          if (hit && hit.value) { value = hit.value; log("match por ID en arreglo:", fid); break; }
        }
      }

      log("valor:", value ? value.slice(0,200) : "(vac√≠o)");
      document.getElementById("summary").innerText = value || "Sin resumen disponible";
    } catch (e) {
      log("ERROR:", e.message || e);
      document.getElementById("summary").innerText = "‚ö†Ô∏è Error: " + (e.message || e);
    }
  }

  load();
</script>
