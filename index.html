<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Summary</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #summary {
      white-space: pre-wrap; background: #f5f5f5; padding: 10px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    #debug {
      margin-top: 12px; font-size: 12px; opacity: .8;
      background: #fafafa; border: 1px dashed #ddd; padding: 8px;
    }
  </style>
</head>
<body>
  <h2>üìù Client Summary</h2>
  <div id="summary">Cargando...</div>
  <pre id="debug"></pre>

 <script>
  // ‚ö†Ô∏è API KEY (misma subcuenta del contacto)
  const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6IjB0N1JJYXNYZ3Vmekt3WmFSVzByIiwidmVyc2lvbiI6MSwiaWF0IjoxNzU4NDQwNjA2ODcyLCJzdWIiOiJRT05DeVdOU2d1U0U2bHVlMEhZMSJ9.tZK7SGvu8mf12cCGCjP5pAMxSWNf1stfNjm_l9vqPas";

  const params    = new URLSearchParams(location.search);
  const contactId = params.get("contactId");

  // Unique key EXACTA (sin llaves) y nombre visible
  const SUMMARY_FIELD_KEY  = "contact.client_summary";
  const SUMMARY_FIELD_NAME = "Client Summary";

  const HDRS = { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" };
  const log  = (...a)=>{ const d=document.getElementById("debug"); if(d) d.textContent+=a.join(" ")+"\n"; console.log(...a); };

  async function j(url){ const r=await fetch(url,{headers:HDRS,cache:"no-store"}); if(!r.ok) throw new Error(r.status+" "+r.statusText+" @ "+url); return r.json(); }
  const norm = s => (s||"").trim().toLowerCase();
  const pickValue = o => o?.value ?? o?.field_value ?? o?.fieldValue ?? o?.text ?? o?.stringValue ?? "";

  // Trae IDs de campos llamados "Client Summary" (por si hubiera duplicados)
  async function getFieldIdsByName() {
    const data = await j("https://rest.gohighlevel.com/v1/custom-fields");
    const list = data.customFields || [];
    const ids  = list.filter(f => (f.model==="contact"||!f.model) && norm(f.name)===norm(SUMMARY_FIELD_NAME)).map(f=>f.id);
    log("coincidencias por nombre:", ids.length);
    return ids;
  }

  // 1) Intenta obtener valores desde endpoints dedicados a custom fields del contacto
  async function fetchContactCFValues() {
    const candidates = [
      `https://rest.gohighlevel.com/v2/contacts/${contactId}/customFields`,
      `https://rest.gohighlevel.com/v1/contacts/${contactId}/customFields`,
      `https://rest.gohighlevel.com/v1/contacts/${contactId}/custom-fields`
    ];
    for (const url of candidates) {
      try {
        const data = await j(url);
        const arr = Array.isArray(data) ? data : (Array.isArray(data.customFields) ? data.customFields : (Array.isArray(data.data) ? data.data : []));
        if (arr.length) { log("endpoint valores OK:", url, "| items:", arr.length); return arr; }
      } catch (e) {
        log("endpoint valores falla:", e.message);
      }
    }
    return [];
  }

  // 2) Fallback: intenta traer el contacto y leer obj/arr si existieran
  async function fetchContactCFInline() {
    const candidates = [
      `https://rest.gohighlevel.com/v1/contacts/${contactId}?include=customFields`,
      `https://rest.gohighlevel.com/v1/contacts/${contactId}`,
      `https://rest.gohighlevel.com/v2/contacts/${contactId}`
    ];
    for (const url of candidates) {
      try {
        const c = await j(url);
        const obj = c && typeof c.customField === "object" ? c.customField : null;
        const arr = Array.isArray(c?.customFields) ? c.customFields : [];
        log("inline prueba:", url, "| has obj:", !!obj, "| arr len:", arr.length);
        if (obj || arr.length) return { obj, arr };
      } catch (e) {
        log("inline falla:", e.message);
      }
    }
    return { obj:null, arr:[] };
  }

  async function load() {
    try {
      if (!contactId) throw new Error("No lleg√≥ contactId en la URL");
      log("contactId:", contactId);

      const ids = await getFieldIdsByName();

      // A) Primero, intenta endpoints de valores
      let value = "";
      const valuesArr = await fetchContactCFValues();
      if (valuesArr.length) {
        // Busca por key, por id o por nombre
        const hitKey = valuesArr.find(it => norm(it.key||it.fieldKey||"") === norm(SUMMARY_FIELD_KEY));
        const hitId  = valuesArr.find(it => ids.includes(it.id||it.customFieldId));
        const hitNm  = valuesArr.find(it => norm(it.name||it.label||"")===norm(SUMMARY_FIELD_NAME));
        const hit = hitKey || hitId || hitNm;
        if (hit) {
          value = pickValue(hit) || "";
          log("match en endpoint valores:", JSON.stringify({key:hit?.key||hit?.fieldKey, id:hit?.id||hit?.customFieldId, name:hit?.name||hit?.label, val:String(value).slice(0,80)}));
        }
      }

      // B) Si no hubo suerte, intenta leerlo inline desde el contacto
      if (!value) {
        const {obj, arr} = await fetchContactCFInline();

        if (obj) {
          if (SUMMARY_FIELD_KEY in obj && obj[SUMMARY_FIELD_KEY]) { value = obj[SUMMARY_FIELD_KEY]; log("match por KEY en obj"); }
          for (const fid of ids) { if (!value && obj[fid]) { value = obj[fid]; log("match por ID en obj:", fid); } }
          if (!value) {
            const keyHit = Object.keys(obj).find(k => k.toLowerCase().includes("client_summary"));
            if (keyHit && obj[keyHit]) { value = obj[keyHit]; log("match por substring en obj:", keyHit); }
          }
        }
        if (!value && arr && arr.length) {
          for (const it of arr) {
            const kid   = it.id ?? it.customFieldId ?? it.key ?? it.fieldKey ?? "";
            const kname = norm(it.name ?? it.label ?? "");
            const val   = pickValue(it);
            if ((kid && (ids.includes(kid) || norm(kid)===norm(SUMMARY_FIELD_KEY))) || (kname===norm(SUMMARY_FIELD_NAME))) {
              if (val) { value = val; log("match en arr inline:", JSON.stringify({kid,kname,val:String(val).slice(0,80)})); break; }
            }
          }
        }
      }

      log("valor:", value ? String(value).slice(0,200) : "(vac√≠o)");
      document.getElementById("summary").innerText = value || "Sin resumen disponible";
    } catch (e) {
      log("ERROR:", e.message || e);
      document.getElementById("summary").innerText = "‚ö†Ô∏è Error: " + (e.message || e);
    }
  }

  load();
</script>



