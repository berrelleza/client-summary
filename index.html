<script>
  const urlParams = new URLSearchParams(window.location.search);
  const contactId = urlParams.get("contactId");
  const apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6IjB0N1JJYXNYZ3Vmekt3WmFSVzByIiwidmVyc2lvbiI6MSwiaWF0IjoxNzUyNjE1ODMwMjI2LCJzdWIiOiJRT05DeVdOU2d1U0U2bHVlMEhZMSJ9.Ufvz6D6JDPKOI46oUer34Kznr1V8Dh--k2arVp55Q1g"; // <- tu API key de la subcuenta
  const headers = { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" };

  const SUMMARY_FIELD_NAME = "Client Summary"; // nombre visible del campo en GHL

  async function getClientSummaryFieldId() {
    // 1) Trae el catálogo de Custom Fields de la subcuenta
    const res = await fetch("https://rest.gohighlevel.com/v1/custom-fields", { headers });
    const data = await res.json();
    const list = data.customFields || [];

    // Busca el campo por nombre (ignorando mayúsculas/minúsculas y espacios)
    const target = list.find(f =>
      (f.model === "contact" || !f.model) &&
      (f.name || "").trim().toLowerCase() === SUMMARY_FIELD_NAME.toLowerCase()
    );

    if (!target) throw new Error(`No encontré el custom field "${SUMMARY_FIELD_NAME}"`);
    return target.id; // <-- ESTE es el ID que necesitamos para leer el valor en el contacto
  }

  async function getContactAndRender(fieldId) {
    const res = await fetch(`https://rest.gohighlevel.com/v1/contacts/${contactId}`, { headers });
    const data = await res.json();

    let value = "";

    // v1 a veces devuelve como objeto { [fieldId]: value }
    if (data.customField && typeof data.customField === "object") {
      value = data.customField[fieldId] || "";
    }

    // otras veces llega como array [{ id, value }]
    if (!value && Array.isArray(data.customFields)) {
      const hit = data.customFields.find(cf => cf.id === fieldId);
      value = hit ? (hit.value || "") : "";
    }

    document.getElementById("summary").innerText = value || "Sin resumen disponible";
  }

  async function loadSummary() {
    try {
      if (!contactId) throw new Error("No llegó contactId en la URL");
      const fieldId = await getClientSummaryFieldId();
      await getContactAndRender(fieldId);
    } catch (e) {
      console.error(e);
      document.getElementById("summary").innerText = "⚠️ Error al cargar.";
      // Depuración opcional en pantalla:
      const dbg = document.createElement("div");
      dbg.style.cssText = "margin-top:8px;font-size:12px;opacity:.7";
      dbg.textContent = "DEBUG: " + (e && e.message ? e.message : String(e));
      document.body.appendChild(dbg);
    }
  }

  loadSummary();
</script>
