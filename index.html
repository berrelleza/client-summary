<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Summary</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #summary {
      white-space: pre-wrap; background: #f5f5f5; padding: 10px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    #debug {
      margin-top: 12px; font-size: 12px; opacity: .8;
      background: #fafafa; border: 1px dashed #ddd; padding: 8px;
    }
  </style>
</head>
<body>
  <h2>üìù Client Summary</h2>
  <div id="summary">Cargando...</div>
  <pre id="debug"></pre>

 <script>
  // ‚ö†Ô∏è API KEY de la MISMA subcuenta del contacto
  const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6IjB0N1JJYXNYZ3Vmekt3WmFSVzByIiwidmVyc2lvbiI6MSwiaWF0IjoxNzU4NDQwNjA2ODcyLCJzdWIiOiJRT05DeVdOU2d1U0U2bHVlMEhZMSJ9.tZK7SGvu8mf12cCGCjP5pAMxSWNf1stfNjm_l9vqPas";

  const p = new URLSearchParams(location.search);
  const contactId  = (p.get("contactId")  || "").trim();
  const locationId = (p.get("locationId") || "").trim();  // <-- IMPORTANTE

  const SUMMARY_FIELD_KEY  = "contact.client_summary";     // unique key exacta
  const SUMMARY_FIELD_NAME = "Client Summary";             // etiqueta visible

  const HDRS = { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" };
  const log  = (...a)=>{ const d=document.getElementById("debug"); if(d) d.textContent+=a.join(" ")+"\n"; console.log(...a); };
  const norm = s => (s||"").trim().toLowerCase();
  const pick = o => o?.value ?? o?.field_value ?? o?.fieldValue ?? o?.text ?? o?.stringValue ?? "";

  async function j(url){
    const r = await fetch(url, { headers: HDRS, cache: "no-store" });
    if (!r.ok) throw new Error(r.status+" @ "+url);
    return r.json();
  }

  // Endpoints que suelen devolver los valores de CF cuando se pasa locationId
  async function fetchValues() {
    if (!contactId) throw new Error("Falta contactId");
    if (!locationId) throw new Error("Falta locationId");
    const urls = [
      // 1) Ruta m√°s frecuente para valores de CF
      `https://rest.gohighlevel.com/v1/contacts/custom-fields?locationId=${encodeURIComponent(locationId)}&contactId=${encodeURIComponent(contactId)}`,
      // 2) Variantes por si tu instancia expone estas
      `https://rest.gohighlevel.com/v2/contacts/${encodeURIComponent(contactId)}/customFields?locationId=${encodeURIComponent(locationId)}`,
      `https://rest.gohighlevel.com/v1/contacts/${encodeURIComponent(contactId)}/customFields?locationId=${encodeURIComponent(locationId)}`,
    ];
    for (const url of urls) {
      try {
        const data = await j(url);
        const arr = Array.isArray(data) ? data
                  : Array.isArray(data.customFields) ? data.customFields
                  : Array.isArray(data.data) ? data.data
                  : [];
        log("probe valores:", url, "| items:", arr.length);
        if (arr.length) return arr;
      } catch(e){ log("sin valores aqu√≠:", e.message); }
    }
    return [];
  }

  // Fallback: intentar inline por si tu build lo trae en el contacto
  async function fetchInline() {
    const urls = [
      `https://rest.gohighlevel.com/v1/contacts/${encodeURIComponent(contactId)}?include=customField&locationId=${encodeURIComponent(locationId)}`,
      `https://rest.gohighlevel.com/v1/contacts/${encodeURIComponent(contactId)}?include=customFields&locationId=${encodeURIComponent(locationId)}`
    ];
    for (const url of urls) {
      try {
        const c = await j(url);
        const obj = c && typeof c.customField === "object" ? c.customField : null;
        const arr = Array.isArray(c?.customFields) ? c.customFields : [];
        log("probe inline:", url, "| obj:", !!obj, "| arr:", arr.length);
        if (obj || arr.length) return { obj, arr };
      } catch(e){ log("inline falla:", e.message); }
    }
    return { obj:null, arr:[] };
  }

  (async () => {
    try {
      log("contactId:", contactId, "| locationId:", locationId);

      // A) Primero busco en endpoints de valores (requieren locationId)
      let value = "";
      const vals = await fetchValues();
      if (vals.length) {
        // Busca por unique key, por nombre y por id/prop clave
        const byKey = vals.find(v => norm(v.key||v.fieldKey||"") === norm(SUMMARY_FIELD_KEY));
        const byNm  = vals.find(v => norm(v.name||v.label||"") === norm(SUMMARY_FIELD_NAME));
        const hit   = byKey || byNm;
        if (hit) {
          value = pick(hit) || "";
          log("match valores:", JSON.stringify({key:hit.key||hit.fieldKey, name:hit.name||hit.label, val:String(value).slice(0,80)}));
        }
      }

      // B) Fallback inline
      if (!value) {
        const { obj, arr } = await fetchInline();
        if (obj && (SUMMARY_FIELD_KEY in obj)) {
          value = obj[SUMMARY_FIELD_KEY] || "";
          log("match inline obj por KEY");
        }
        if (!value && arr && arr.length) {
          const it = arr.find(v =>
            norm(v.key||v.fieldKey||"") === norm(SUMMARY_FIELD_KEY) ||
            norm(v.name||v.label||"")   === norm(SUMMARY_FIELD_NAME)
          );
          if (it) { value = pick(it) || ""; log("match inline arr"); }
        }
      }

      document.getElementById("summary").innerText = value || "Sin resumen disponible";
      log("valor:", value ? String(value).slice(0,200) : "(vac√≠o)");
    } catch (e) {
      document.getElementById("summary").innerText = "‚ö†Ô∏è " + (e.message || e);
      log("ERROR:", e.message || e);
    }
  })();
</script>
