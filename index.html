<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Summary</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #summary {
      white-space: pre-wrap; background: #f5f5f5; padding: 10px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    #debug {
      margin-top: 12px; font-size: 12px; opacity: .8;
      background: #fafafa; border: 1px dashed #ddd; padding: 8px;
    }
  </style>
</head>
<body>
  <h2>üìù Client Summary</h2>
  <div id="summary">Cargando...</div>
  <pre id="debug"></pre>

  <script>
  // ‚ö†Ô∏è API KEY de la MISMA subcuenta que el contacto
  const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6IjB0N1JJYXNYZ3Vmekt3WmFSVzByIiwidmVyc2lvbiI6MSwiaWF0IjoxNzUyNjE1ODMwMjI2LCJzdWIiOiJRT05DeVdOU2d1U0U2bHVlMEhZMSJ9.Ufvz6D6JDPKOI46oUer34Kznr1V8Dh--k2arVp55Q1g";

  const params    = new URLSearchParams(location.search);
  const contactId = params.get("contactId");

  // Unique key EXACTA (sin llaves) y nombre visible
  const SUMMARY_FIELD_KEY  = "contact.client_summary";
  const SUMMARY_FIELD_NAME = "Client Summary";

  const HDRS = { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" };
  const log  = (...a)=>{ const d=document.getElementById("debug"); if(d) d.textContent+=a.join(" ")+"\n"; console.log(...a); };

  async function j(url){ const r=await fetch(url,{headers:HDRS,cache:"no-store"}); return r.json(); }

  // IDs de los campos que se llaman ‚ÄúClient Summary‚Äù (por si hay duplicados)
  async function getFieldIdsByName() {
    const data = await j("https://rest.gohighlevel.com/v1/custom-fields");
    const list = data.customFields || [];
    const norm = s => (s||"").trim().toLowerCase();
    const ids  = list.filter(f => (f.model==="contact"||!f.model) && norm(f.name)===norm(SUMMARY_FIELD_NAME))
                     .map(f => f.id);
    log("coincidencias por nombre:", ids.length);
    return ids;
  }

  function pickValue(item){
    // distintas formas en que llega el valor
    return item?.value ?? item?.field_value ?? item?.fieldValue ?? item?.text ?? item?.stringValue ?? "";
  }

  async function load() {
    try {
      if (!contactId) throw new Error("No lleg√≥ contactId en la URL");
      log("contactId:", contactId);

      const ids = await getFieldIdsByName();

      // Trae el contacto (incluimos customFields)
      const c = await j(`https://rest.gohighlevel.com/v1/contacts/${contactId}?include=customFields`);
      // Dump parcial para inspecci√≥n
      log("has customField obj:", !!c.customField);
      log("customFields array len:", Array.isArray(c.customFields) ? c.customFields.length : 0);

      // Muestra 1‚Äì2 ejemplos de lo que trae, recortado
      if (c.customField) {
        const keys = Object.keys(c.customField);
        log("customField keys (primeras):", keys.slice(0,15).join(", "));
        if (keys.length) log("customField sample:", keys[0], "=", String(c.customField[keys[0]]).slice(0,120));
      }
      if (Array.isArray(c.customFields) && c.customFields.length) {
        const it = c.customFields[0];
        log("customFields[0] sample:", JSON.stringify({
          id: it.id, customFieldId: it.customFieldId, key: it.key, name: it.name, label: it.label,
          value: pickValue(it)
        }).slice(0,220));
      }

      let value = "";

      // 1) Por KEY directa en el objeto customField
      if (c.customField && typeof c.customField === "object" && SUMMARY_FIELD_KEY in c.customField) {
        value = c.customField[SUMMARY_FIELD_KEY] || "";
        if (value) log("match por KEY:", SUMMARY_FIELD_KEY);
      }

      // 2) Por ID en el objeto customField
      if (!value && c.customField && typeof c.customField === "object") {
        for (const fid of ids) {
          if (c.customField[fid]) { value = c.customField[fid]; log("match por ID en objeto:", fid); break; }
        }
      }

      // 3) Por ID/KEY/NOMBRE en el array customFields
      if (!value && Array.isArray(c.customFields)) {
        for (const item of c.customFields) {
          const kid   = item.id ?? item.customFieldId ?? item.key ?? item.fieldKey ?? "";
          const kname = (item.name ?? item.label ?? "").trim().toLowerCase();
          const val   = pickValue(item);

          if (
            (kid && (ids.includes(kid) || kid === SUMMARY_FIELD_KEY)) ||
            (kname && kname === SUMMARY_FIELD_NAME.toLowerCase())
          ) {
            if (val) { value = val; log("match en arreglo:", JSON.stringify({kid, kname, val: String(val).slice(0,80)})); break; }
          }
        }
      }

      // 4) Heur√≠stica: cualquier clave en el objeto que contenga 'client_summary'
      if (!value && c.customField && typeof c.customField === "object") {
        const keyHit = Object.keys(c.customField).find(k => k.toLowerCase().includes("client_summary"));
        if (keyHit && c.customField[keyHit]) { value = c.customField[keyHit]; log("match por substring en objeto:", keyHit); }
      }

      log("valor:", value ? String(value).slice(0,200) : "(vac√≠o)");
      document.getElementById("summary").innerText = value || "Sin resumen disponible";
    } catch (e) {
      log("ERROR:", e.message || e);
      document.getElementById("summary").innerText = "‚ö†Ô∏è Error: " + (e.message || e);
    }
  }

  load();
</script>
