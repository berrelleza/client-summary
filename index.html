<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Summary</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #summary {
      white-space: pre-wrap; background: #f5f5f5; padding: 10px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    #debug {
      margin-top: 12px; font-size: 12px; opacity: .8;
      background: #fafafa; border: 1px dashed #ddd; padding: 8px;
    }
  </style>
</head>
<body>
  <h2>üìù Client Summary</h2>
  <div id="summary">Cargando...</div>
  <pre id="debug"></pre>

  <script>
    // ‚ö†Ô∏è CAMBIA ESTO POR TU API KEY DE LA SUBCUENTA
    const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6IjB0N1JJYXNYZ3Vmekt3WmFSVzByIiwidmVyc2lvbiI6MSwiaWF0IjoxNzUyNjE1ODMwMjI2LCJzdWIiOiJRT05DeVdOU2d1U0U2bHVlMEhZMSJ9.Ufvz6D6JDPKOI46oUer34Kznr1V8Dh--k2arVp55Q1g";

    const params   = new URLSearchParams(location.search);
    const contactId = params.get("contactId");
    const HDRS = { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" };

    const SUMMARY_FIELD_NAME = "Client Summary"; // escribe el NOMBRE EXACTO del campo

    const log = (...a) => { document.getElementById("debug").textContent += a.join(" ") + "\n"; };

    async function fetchJson(url) {
      const r = await fetch(url, { headers: HDRS, cache: "no-store" });
      const j = await r.json();
      return j;
    }

    async function getSummaryFieldId() {
      const data = await fetchJson("https://rest.gohighlevel.com/v1/custom-fields");
      const list = data.customFields || [];
      log("customFields:", Array.isArray(list) ? list.length : 0);

      const found = list.find(f =>
        (f.model === "contact" || !f.model) &&
        (f.name || "").trim().toLowerCase() === SUMMARY_FIELD_NAME.toLowerCase()
      );
      if (!found) throw new Error(`No encontr√© el campo "${SUMMARY_FIELD_NAME}"`);
      log("fieldId:", found.id, "| label:", found.name);
      return found.id;
    }

    async function load() {
      try {
        if (!contactId) throw new Error("No lleg√≥ contactId en la URL");
        log("contactId:", contactId);

        const fieldId = await getSummaryFieldId();

        const contact = await fetchJson(`https://rest.gohighlevel.com/v1/contacts/${contactId}`);

        let value = "";

        // Formato 1: objeto { [fieldId]: value }
        if (contact.customField && typeof contact.customField === "object") {
          value = contact.customField[fieldId] || "";
        }

        // Formato 2: arreglo [{ id, value }]
        if (!value && Array.isArray(contact.customFields)) {
          const hit = contact.customFields.find(cf => cf.id === fieldId);
          value = hit ? (hit.value || "") : "";
        }

        log("valor:", value ? value.slice(0,200) : "(vac√≠o)");
        document.getElementById("summary").innerText = value || "Sin resumen disponible";
      } catch (e) {
        log("ERROR:", e.message || e);
        document.getElementById("summary").innerText = "‚ö†Ô∏è Error: " + (e.message || e);
      }
    }

    load();
  </script>
</body>
</html>
